# Sealos SRE Agent (v2.5 Release) - 开发文档

## 1. 项目简介

### 项目概述
Sealos SRE Agent 是一个基于 MCP (Model Context Protocol) 的智能运维助手，专门为 Sealos 云原生环境设计。它通过自然语言接口帮助 SRE 工程师和开发人员快速查询和管理 Kubernetes 集群资源。

### 核心价值
- **简化运维操作**: 将复杂的 kubectl 命令转换为简单的自然语言指令
- **智能资源查询**: 支持 Pods、Devbox、KubeBlocks 数据库等多种资源类型
- **统一交互界面**: 通过 REPL 模式提供一致的命令行体验
- **错误诊断**: 提供详细的错误信息和调试能力

### 典型使用场景
```bash
# 查询 Pod 列表
sealos > ns-mh69tey1 pods hzh

# 查询 Devbox 实例
sealos > ns-mh69tey1 devbox hzh

# 查询数据库集群
sealos > ns-mh69tey1 cluster hzh
```

## 2. 整体架构与模块说明

### 架构概览
```
┌─────────────────┐    AI服务     ┌─────────────────┐    MCP协议     ┌─────────────────┐
│   Client 端     │ ──────────> │   Server 端     │ ──────────> │  Kubernetes API │
│                 │             │                 │             │                 │
│ • 用户交互界面   │             │ • MCP 服务器     │             │ • CoreV1Api     │
│ • AI 参数清洗    │             │ • 工具路由       │             │ • CustomObjectsApi │
│ • 结果渲染       │             │ • 错误处理       │             │ • CRD 查询      │
└─────────────────┘             └─────────────────┘             └─────────────────┘
```

### 核心模块

#### 2.1 Client 端模块 (`src/client/`)
- **AI Service (`ai/ai-service.ts`)**:
  - 职责: 将用户输入的三个参数清洗为结构化格式
  - 输入: `[namespace, resource, identifier]`
  - 输出: `{namespace, resource, identifier}`
  - 支持资源: pods, devbox, cluster

- **主控制器 (`index.ts`)**:
  - 职责: REPL 模式管理、MCP 通信、结果渲染
  - 功能: 用户输入处理、MCP 任务执行、表格显示

#### 2.2 Server 端模块 (`src/server/`)
- **MCP 服务器 (`index.ts`)**:
  - 职责: 工具注册、请求路由、错误处理
  - 支持: list_pods_by_ns, list_devbox_by_ns, list_cluster_by_ns

- **Kubernetes 客户端 (`kubernetes/client.ts`)**:
  - 职责: K8s API 连接管理、认证处理
  - 支持: CoreV1Api (Pods), CustomObjectsApi (CRDs)

- **工具实现 (`tools/`)**:
  - `list-pods-by-ns.ts`: Pod 查询实现
  - `list-devbox-by-ns.ts`: Devbox CRD 查询
  - `list-cluster-by-ns.ts`: KubeBlocks 数据库查询

## 3. 主要功能与特性 (v2.5 新增/改动)

### 3.1 DNS 解析修复 (v2.5 Blocker Fix)
**问题**: Node.js v17+ 在 Kubernetes 环境下 DNS 解析失败 (ENOTFOUND)
**解决方案**: 强制使用 IPv4 优先的 DNS 解析策略
```typescript
// src/client/index.ts 顶部添加
import dns from 'dns';
dns.setDefaultResultOrder('ipv4first');
```
**技术决策**: 选择该方案是因为它是 Node.js 官方推荐的方式，兼容性最好

### 3.2 JSON-RPC 错误处理增强
**问题**: Client 端忽略 Server 返回的错误响应，导致用户看到超时而非具体错误
**解决方案**:
```typescript
// 检查 response.error 字段
if (response.error) {
  console.error('[Server Error Response]', JSON.stringify(response.error, null, 2));
  reject(new Error(`Server returned error: ${response.error.message}`));
}
```

### 3.3 人性化表格显示 (UI/UX 改进)
**问题**: 原始 JSON 输出难以阅读，干扰用户视线
**解决方案**: 实现模式匹配的表格渲染
```typescript
// Pod 表格
if (data.pods && Array.isArray(data.pods)) {
  console.table(data.pods.map(p => ({
    Name: p.name,
    Status: p.status,
    IP: p.ip,
    Node: p.node
  })));
}

// Devbox 表格
if (data.devboxes && Array.isArray(data.devboxes)) {
  console.table(data.devboxes.map(d => ({
    Name: d.name,
    Status: d.status,
    Network: JSON.stringify(d.network)
  })));
}

// Cluster 表格
if (data.clusters && Array.isArray(data.clusters)) {
  console.table(data.clusters.map(c => ({
    Name: c.name,
    Type: c.type,
    Status: c.status,
    Version: c.version
  })));
}
```

### 3.4 Devbox 资源支持 (新增)
**需求**: 支持 Sealos Devbox CRD 查询
**实现**:
- CRD Group: `devbox.sealos.io`
- Version: `v1alpha1`
- Plural: `devboxes`
- 提取字段: name, status, network

### 3.5 KubeBlocks 集群支持 (新增)
**需求**: 支持 KubeBlocks 数据库集群查询
**设计约束**: 严格保持单数形式 "cluster"，符合用户习惯
**实现**:
- CRD Group: `apps.kubeblocks.io`
- Version: `v1alpha1`
- Plural: `clusters` (K8s API 要求)
- 提取字段: name, status, type, version
- 类型识别: clusterDefinitionRef (redis, mysql, postgresql)

## 4. 接口、方法与调用流程

### 4.1 关键接口

#### MCP 协议接口
```typescript
// 工具调用请求
{
  "jsonrpc": "2.0",
  "id": Date.now(),
  "method": "tools/call",
  "params": {
    "name": "list_pods_by_ns",  // | list_devbox_by_ns | list_cluster_by_ns
    "arguments": {
      "namespace": "ns-xxx"
    }
  }
}

// 工具调用响应
{
  "content": [
    {
      "type": "text",
      "text": JSON.stringify(result, null, 2)
    }
  ]
}
```

#### Kubernetes API 调用
```typescript
// Pods 查询
const podList = await k8sApi.listNamespacedPod(namespace);

// Devbox CRD 查询
const devboxList = await customObjectsApi.listNamespacedCustomObject(
  'devbox.sealos.io', 'v1alpha1', namespace, 'devboxes'
);

// KubeBlocks CRD 查询
const clusterList = await customObjectsApi.listNamespacedCustomObject(
  'apps.kubeblocks.io', 'v1alpha1', namespace, 'clusters'
);
```

### 4.2 重要方法

#### AI 参数清洗 (`src/client/ai/ai-service.ts`)
```typescript
async parseRawInput(rawArgs: string[]): Promise<CleanedParameters | null>
```
- **功能**: 将乱序的三参数输入清洗为标准格式
- **调用时机**: 用户输入指令后，调用 MCP 前执行
- **输出格式**: `{namespace, resource, identifier}`

#### MCP 任务执行 (`src/client/index.ts`)
```typescript
async runMcpTask(params: CleanedParameters): Promise<void>
```
- **功能**: 启动 MCP Server 进程，发送工具调用请求
- **调用时机**: AI 参数清洗完成后
- **处理逻辑**: 根据资源类型路由到对应工具

#### 结果渲染 (`src/client/index.ts`)
```typescript
function displayResults(result: any): void
```
- **功能**: 将 MCP 响应渲染为用户友好的表格格式
- **模式匹配**: 识别 data.pods, data.devboxes, data.clusters
- **错误处理**: 显示结构化错误信息

### 4.3 典型调用流程

```
用户输入: "ns-mh69tey1 cluster hzh"
    ↓
1. AI 参数清洗 (ai-service.ts)
   - 解析: resource="cluster", namespace="ns-mh69tey1", identifier="hzh"
   ↓
2. MCP 任务路由 (runMcpTask)
   - toolName = "list_cluster_by_ns"
   ↓
3. MCP Server 处理 (server/index.ts)
   - 路由到 listClusterByNamespace 函数
   ↓
4. Kubernetes API 调用 (list-cluster-by-ns.ts)
   - 查询 apps.kubeblocks.io/v1alpha1 clusters
   - 转换为 {namespace, clusters[], total} 格式
   ↓
5. 结果渲染 (displayResults)
   - 检测到 data.clusters
   - 显示: Name | Type | Status | Version 表格
```

## 5. 当前工作流 / 使用方式

### 5.1 输入格式规范
```
<namespace> <resource> <identifier>
```
- **namespace**: 必须以 "ns-" 开头，如 "ns-mh69tey1"
- **resource**: 支持 "pods", "devbox", "cluster" (单数形式)
- **identifier**: 固定值 "hzh"

### 5.2 AI Prompt 模板 (中文)
```typescript
你是一个参数清洗工具。任务是将乱序的三参数输入清洗为标准 JSON 格式。

规则：
- identifier: 固定值 "hzh"
- resource: 枚举值 "pods" | "devbox" | "cluster"
- namespace: 以 "ns-" 开头的字符串

要求：
1. 如果输入包含 "cluster"（忽略大小写），resource 返回 "cluster"
2. 如果输入包含 "devbox"（忽略大小写），resource 返回 "devbox"
3. 保持单数形式，不要返回复数
```

### 5.3 开发约定
- **工具命名**: 使用单数形式 `list_<resource>_by_ns`
- **K8s API**: 使用复数形式查询 (CRD 规范要求)
- **响应格式**: 统一使用 `{namespace, <resource>[], total, success, error?}`
- **错误处理**: 结构化错误信息，包含 message 和可选的 details
- **日志格式**: 使用前缀 `[Client]`, `[Server]`, `[AI]` 区分模块

## 6. 技术细节与实现要点

### 6.1 DNS 解析策略
```typescript
// 必须在其他导入之前执行
import dns from 'dns';
try {
  dns.setDefaultResultOrder('ipv4first');
} catch (e) {
  // 兼容旧版本 Node.js
}
```

### 6.2 MCP 通信模式
- **进程模型**: Client 启动 Server 作为子进程，通过 stdio 通信
- **超时机制**: 30秒超时，防止无限等待
- **错误处理**: 优先检查 response.error，避免超时误解

### 6.3 Kubernetes 客户端设计
```typescript
export class KubernetesClient {
  private kc: k8s.KubeConfig;
  private k8sApi: k8s.CoreV1Api;           // Pods 资源
  private customObjectsApi: k8s.CustomObjectsApi; // CRD 资源

  getApiClient(): k8s.CoreV1Api
  getCustomObjectsApi(): k8s.CustomObjectsApi
}
```

### 6.4 错误处理策略
- **Server 端**: 捕获 K8s API 错误，提取有意义的信息
- **Client 端**: 区分网络错误、解析错误、业务错误
- **用户友好**: 避免堆栈跟踪，显示可操作的错误信息

### 6.5 单复数命名规范
| 层级 | 用户接口 | AI Prompt | 工具命名 | K8s API | 响应数据 |
|------|----------|-----------|----------|----------|----------|
| 资源类型 | cluster | cluster | list_cluster_by_ns | clusters | clusters[] |
| 资源类型 | devbox | devbox | list_devbox_by_ns | devboxes | devboxes[] |
| 资源类型 | pods | pods | list_pods_by_ns | pods | pods[] |

## 7. 已知问题 / 限制 & 后续 TODO

### 7.1 已知限制
1. **资源类型硬编码**: 新增资源类型需要修改多处代码
2. **固定参数格式**: 必须严格按照三参数格式输入
3. **单命名空间**: 每次查询仅支持单个命名空间
4. **只读操作**: 当前版本仅支持查询，不支持资源创建/修改

### 7.2 已解决的问题
- ✅ DNS 解析失败 (ENOTFOUND)
- ✅ JSON-RPC 错误响应被忽略
- ✅ 原始 JSON 输出不友好
- ✅ 不支持 Devbox 资源查询
- ✅ 不支持 KubeBlocks 集群查询

### 7.3 后续优化建议
1. **配置化资源定义**: 通过配置文件定义支持的资源类型，避免硬编码
2. **批量操作支持**: 支持跨命名空间查询或批量操作
3. **资源操作扩展**: 支持创建、更新、删除等操作
4. **智能提示**: 提供自动补全和命令提示功能
5. **缓存机制**: 对频繁查询的缓存结果，提高响应速度
6. **监控集成**: 增加操作日志、性能指标和告警
### 7.4 技术债务
- AI Prompt 仍然使用中文，建议考虑国际化支持
- 错误消息可以更加用户友好和可操作
- 可以考虑添加配置文件支持，减少硬编码
---
**版本**: v2.5
**最后更新**: 2025-12-08
**主要贡献**: 完整的端到端资源查询支持，包括 DNS 修复、错误处理增强、UI 改进和三种资源类型支持